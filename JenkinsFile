pipeline {
    agent any

    environment {
        PROJECT_ID   = "springbootmicroservicetp"
        REGION       = "europe-west1"
        REPO         = "springbootmicroserve-repo"
        SERVICE_NAME = "runner-ms"

        IMAGE_TAG = "${BUILD_NUMBER}"
        IMAGE = "${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${SERVICE_NAME}:${IMAGE_TAG}"
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/MOHAMMED-BE/springboot-microservice.git'
            }
        }

        stage('Build JAR (skip tests)') {
            steps {
                bat '''
                    @echo on
                    call mvn clean install -DskipTests
                    dir runner-ms\\target
                '''
            }
        }
        
        stage('SonarQube Analysis') {
            when { 
                expression { return env.CHANGE_ID == null } 
            }
            steps {
                bat """
                    @echo on
                    echo Sonar project key: %SERVICE_NAME%

                    call mvn -DskipTests sonar:sonar ^
                    -Dsonar.projectKey=%SERVICE_NAME% ^
                    -Dsonar.projectName=%SERVICE_NAME% ^
                    -Dsonar.host.url=http://<SONAR_HOST>:9000 ^
                    -Dsonar.token=%SONAR_TOKEN%
                """
            }
        }

        // stage('Quality Gate') {
        //     when { expression { return env.CHANGE_ID == null } }
        //     steps {
        //         timeout(time: 5, unit: 'MINUTES') {
        //             waitForQualityGate abortPipeline: true
        //         }
        //     }
        // }

        stage('Build Docker Image') {
            steps {
                bat '''
                    @echo on
                    echo Building image: %IMAGE%
                    docker build -t %IMAGE% .
                '''
            }
        }

        stage('Authenticate & Push Image') {
            steps {
                withCredentials([file(credentialsId: 'gcp-sa-key', variable: 'GCP_KEY_FILE')]) {
                    bat '''
                        @echo on
                        echo Authenticating with service account...
                        call gcloud auth activate-service-account --key-file="%GCP_KEY_FILE%"

                        echo Setting project...
                        call gcloud config set project %PROJECT_ID%

                        echo Configuring docker auth for Artifact Registry...
                        call gcloud auth configure-docker %REGION%-docker.pkg.dev --quiet

                        echo Pushing image: %IMAGE%
                        docker push %IMAGE%
                    '''
                }
            }
        }

        stage('Deploy to Cloud Run') {
            steps {
                withCredentials([file(credentialsId: 'gcp-sa-key', variable: 'GCP_KEY_FILE')]) {
                    bat '''
                        @echo on
                        echo Authenticating with service account...
                        call gcloud auth activate-service-account --key-file="%GCP_KEY_FILE%"

                        echo Setting project...
                        call gcloud config set project %PROJECT_ID%

                        echo Deploying to Cloud Run...
                        call gcloud run deploy %SERVICE_NAME% ^
                          --image %IMAGE% ^
                          --region %REGION% ^
                          --platform managed ^
                          --allow-unauthenticated ^
                          --port 8080

                        echo Fetching service URL...
                        call gcloud run services describe %SERVICE_NAME% ^
                          --region %REGION% ^
                          --platform managed ^
                          --format="value(status.url)"
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ DEPLOYMENT SUCCESSFUL"
            echo "üöÄ Cloud Run service: ${SERVICE_NAME}"
            echo "üîñ Image: ${IMAGE}"
        }
        failure {
            echo "‚ùå PIPELINE FAILED ‚Äì Check logs"
        }
        always {
            echo "Done."
        }
    }
}